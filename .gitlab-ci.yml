# GitLab CI/CD Pipeline for ha-mcp
# Home Assistant MCP Server
# Go Version: 1.25.5
# Repository: gitlab.com/zorak1103/ha-mcp

# Pipeline Stages
stages:
  - lint          # Code quality and formatting
  - test          # Unit tests and coverage
  - security      # Security scans
  - secret-detection  # Secret detection
  - build         # Docker build
  - renovate      # Dependency updates
  - release       # Release creation with goreleaser

# Global Variables
variables:
  # Go-specific settings
  GO_VERSION: "1.25.5"
  CGO_ENABLED: "0"
  GOPROXY: "https://proxy.golang.org,direct"
  
  # Enable secret detection
  SECRET_DETECTION_ENABLED: 'true'
  
  # Cache paths
  GOPATH: $CI_PROJECT_DIR/.go
  GOCACHE: $CI_PROJECT_DIR/.cache/go-build

# Default configuration for all jobs
default:
  tags:
    - private

# Cache configuration for Go modules and build cache
cache:
  key: 
    files:
      - go.sum
  paths:
    - .go/pkg/mod/
    - .cache/go-build/

# ============================================================================
# LINT STAGE - Code Quality and Formatting
# ============================================================================

golangci-lint:
  stage: lint
  image: golang:${GO_VERSION}-alpine
  before_script:
    - apk add --no-cache git gcc musl-dev
    - go install github.com/golangci/golangci-lint/cmd/golangci-lint@v1.64.8
  script:
    - export PATH=$PATH:$(go env GOPATH)/bin
    - golangci-lint --version
    - golangci-lint run -v --timeout=5m
  artifacts:
    reports:
      codequality: gl-code-quality-report.json
    paths:
      - gl-code-quality-report.json
    when: always
    expire_in: 7 days
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  allow_failure: false

# Check Go formatting
go-fmt:
  stage: lint
  image: golang:${GO_VERSION}-alpine
  before_script:
    - apk add --no-cache git
  script:
    # Only format project files, not the module cache
    - gofmt -l -d $(find . -type f -name '*.go' -not -path './.go/*' -not -path './.cache/*') | tee fmt-report.txt
    - test -z "$(gofmt -l $(find . -type f -name '*.go' -not -path './.go/*' -not -path './.cache/*'))"
  artifacts:
    paths:
      - fmt-report.txt
    when: on_failure
    expire_in: 7 days
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  allow_failure: false

# ============================================================================
# TEST STAGE - Unit Tests and Coverage
# ============================================================================

unit-tests:
  stage: test
  image: golang:${GO_VERSION}-alpine
  variables:
    # Enable CGO for race detector
    CGO_ENABLED: "1"
  before_script:
    - apk add --no-cache git gcc musl-dev
    - go version
    - go mod download
  script:
    # Run tests with coverage
    - go test -v -race -coverprofile=coverage.out -covermode=atomic ./...
    
    # Generate coverage report
    - go tool cover -func=coverage.out | tee coverage-report.txt
    
    # Extract coverage percentage
    - |
      COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//')
      echo "Total Coverage: ${COVERAGE}%"
      
      # Check minimum coverage (optional, can be adjusted)
      if [ $(echo "$COVERAGE < 50.0" | bc -l) -eq 1 ]; then
        echo "WARNING: Coverage is below 50%"
      fi
  coverage: '/total:\s+\(statements\)\s+(\d+\.\d+)%/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    paths:
      - coverage.out
      - coverage-report.txt
    when: always
    expire_in: 30 days
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  allow_failure: false

build-syntax-check:
  stage: test
  image: golang:${GO_VERSION}-alpine
  before_script:
    - apk add --no-cache git
    - go version
    - go mod download
  script:
    # Only check syntax and build capability (no full build)
    - echo "Checking build syntax for main package..."
    - go build -n ./cmd/ha-mcp
    
    # Validate package name
    - test -n "$(go list -f '{{.Name}}' ./cmd/ha-mcp)"
    
    - echo "âœ“ Build syntax check passed"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  allow_failure: false

# ============================================================================
# SECURITY STAGE - Security Scans
# ============================================================================

gosec:
  stage: security
  image: golang:${GO_VERSION}-alpine
  before_script:
    - apk add --no-cache git gcc musl-dev
    - go install github.com/securego/gosec/v2/cmd/gosec@latest
  script:
    - export PATH=$PATH:$(go env GOPATH)/bin
    # JSON report for GitLab Security Dashboard
    # Only scan project code, not dependencies (prevents panics in gosec)
    - gosec -fmt json -out gosec-report.json ./cmd/... ./internal/...
    
    # Additional text report for better readability
    - gosec -fmt text -out gosec-report.txt ./cmd/... ./internal/... || true
    
    # Main scan (can fail on findings)
    - gosec ./cmd/... ./internal/... || true
  artifacts:
    reports:
      sast: gosec-report.json
    paths:
      - gosec-report.json
      - gosec-report.txt
    when: always
    expire_in: 30 days
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  allow_failure: false

govulncheck:
  stage: security
  image: golang:${GO_VERSION}-alpine
  before_script:
    - apk add --no-cache git gcc musl-dev
    - go install golang.org/x/vuln/cmd/govulncheck@latest
  script:
    - export PATH=$PATH:$(go env GOPATH)/bin
    # Vulnerability check with detailed output
    - govulncheck -show verbose ./...
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  allow_failure: false

# ============================================================================
# SECRET DETECTION STAGE
# ============================================================================

secret_detection:
  stage: secret-detection

# ============================================================================
# BUILD STAGE - Docker Build
# ============================================================================

build:docker:
  when: never
  stage: build
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
  before_script:
    - docker info
  script:
    - docker build -t $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA .
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG

# ============================================================================
# RENOVATE STAGE - Dependency Updates
# ============================================================================

renovate:
  stage: renovate
  image: renovate/renovate:latest
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: always
    - if: $CI_PIPELINE_SOURCE == "web"
      when: always
  variables:
    RENOVATE_CONFIG_FILE: renovate.json
    LOG_LEVEL: info
    RENOVATE_PLATFORM: gitlab
    RENOVATE_ENDPOINT: $CI_SERVER_URL
  script:
    # Validate renovate configuration
    - renovate-config-validator
    
    # Run renovate
    - renovate --platform gitlab --token $GL_TOKEN --autodiscover
  allow_failure: true

# ============================================================================
# RELEASE STAGE - Release Creation with goreleaser
# ============================================================================

release:
  stage: release
  image:
    name: goreleaser/goreleaser:latest
    entrypoint: [""]
  only:
    - tags
  variables:
    # Disable shallow cloning for full git history
    GIT_DEPTH: 0
    
    # GitLab token for goreleaser (release creation)
    GITLAB_TOKEN: $GITLAB_PAT
  before_script:
    # Check Go version
    - go version
    
    # Download dependencies
    - go mod download
    
    # Display goreleaser version
    - goreleaser --version
  script:
    # Create release with goreleaser
    # --clean: Cleans dist directory before build
    - goreleaser release --clean
  artifacts:
    paths:
      - dist/
    expire_in: 90 days
  needs: []
  allow_failure: false

# ============================================================================
# INCLUDES - GitLab Templates
# ============================================================================

include:
  # Secret Detection Template from GitLab
  - template: Security/Secret-Detection.gitlab-ci.yml
